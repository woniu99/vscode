# chapter 9 基于HTTP的功能追加协议
## 1. HTTP的瓶颈
- 使用HTTP协议探知服务器上是否有更新，就必须频繁地从客户端到服务器端进行确认。如果服务器上没有内容更新，那么就会产生徒劳的通信。

    若想在现有的Web实现所需的功能，以下这些HTTP标准就会成为瓶颈：
    - 一条连接上只可发送一个请求。
    - 请求只能从客户端开始。客户端不可以接收除响应以外的指令。
    - 请求/响应首部未经压缩就发送，首部信息越多延迟越大。
    - 发送冗长的首部。每次互相发送相同的首部造成的浪费较多。
    - 可任意选择数据压缩格式，非强制压缩发送。
## 2.解决方案
### 2.1 Ajax的解决方法
- Ajax(Asynchronous javaScript and XML,异步JavaScript与XML技术)是一种利用Javascript和DOM的操作，以达到局部Web页面替换加载的异步通信手段。和以前的同步通信相比，由于它只更新一部分页面，响应中传输的数据量会因此减少，这一优点显而易见。
- 而利用Ajax实时地从服务器获取内容，有可能会导致大量请求产生。另外，Ajax仍未解决HTTP协议本身存在的问题。
### 2.2 Comet的解决方法
- 一旦服务器端有内容更新了，Comet不会让请求等待，而是直接给客户端返回响应。这是一种通过延迟答应，模拟实现服务器端向客户端推送(Server Push)的功能。
- 通常，服务器端接收到请求，在处理完毕后就会立即返回响应，但为了实现推送功能，Comet会先将响应置于挂起状态，当服务器端有内容更新时，再返回该响应。因此，服务器端一旦有更新，就可以立即反馈给客户端。
- 内容上虽然可以做到实时更新，但为了保留响应，一次连接的持续时间也变长了，期间，为了维持连接会消耗更多的资源。另外，Comet也未解决HTTP协议本身存在的问题。
### 2.3 使用浏览器进行全双工通信的WebSocket
#### 2.3.1 WebSocket协议
- 一旦Web服务器与客户端之间建立起WebSocket协议的通信连接，之后所有的通信都依靠这个专用协议进行。通信过程中可互相发送JSON、XML、HTML或图片等任意格式的数据。
- 由于是建立再HTTP基础上的协议，因此连接的发起方仍是客户端，而一旦确立WebSocket通信连接，不论服务器还是客户端，任意一方都可直接向对方发送报文。
- WebSocket协议的主要特点：
    - **推送功能**
    - 支持由服务器向客户端推送数据的推送功能。这样，服务器可直接发送数据，而不必等待客户端的请求。
    - **减少通信量**
    - 只要建立起WebSocket连接，就希望一直保持连接状态。和HTTP相比，不但每次连接时的总开销减少，而且由于WebSocket的首部信息很少，通信量也相应减少了。
- 为了实现WebSocket通信，在HTTP连接建立之后，需要完成一次“握手（Handshaking)”的步骤。
- **握手·请求**
    为了实现WebSocket通信，需要用到HTTP的Upgrade首部字段，告知服务器通信协议发生改变，以达到握手的目的。
    > `Upgrade:websocket`
- **握手·响应**
    对于之前的请求，返回状态码`101 Switching Protocols`的响应。
    > `http/1.1 101 Switching Protocols`

    > `Upgrade:websocket`
- 成功握手确立WebSocket连接后，通信时不再使用HTTP的数据帧，而采用WebScoket独立的数据帧。
    